# GitHub Actionså·¥ä½œæµï¼šAPIæ–‡æ¡£è´¨é‡ä¿è¯
# æ–‡ä»¶è·¯å¾„: .github/workflows/api-validation.yml

name: API Documentation Quality Assurance

on:
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/api/**/*.yaml'
      - 'docs/api/**/*.yml'
      - 'docs/api/**/validate-api.py'
      - 'docs/api/**/enhanced-api-validator.py'
  
  # åœ¨Pull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/api/**/*.yaml'
      - 'docs/api/**/*.yml'
      - 'docs/api/**/validate-api.py'
      - 'docs/api/**/enhanced-api-validator.py'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'éªŒè¯çº§åˆ«'
        required: true
        default: 'full'
        type: choice
        options:
          - 'basic'
          - 'enhanced'
          - 'full'

jobs:
  api-validation:
    name: APIæ–‡æ¡£è´¨é‡éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²ä»¥ä¾¿è¿›è¡Œå˜æ›´æ£€æµ‹
        fetch-depth: 2
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests
    
    - name: è®¾ç½®Node.jsç¯å¢ƒï¼ˆç”¨äºPrism CLIï¼‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…Prism CLIï¼ˆå¯é€‰ï¼‰
      run: |
        npm install -g @stoplight/prism-cli
      continue-on-error: true
    
    - name: æ£€æŸ¥APIæ–‡æ¡£æ–‡ä»¶å˜æ›´
      id: changes
      run: |
        echo "æ£€æŸ¥APIæ–‡æ¡£ç›¸å…³æ–‡ä»¶å˜æ›´..."
        
        # æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒPRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(yaml|yml)$' | grep -E '(docs/api|modules|domains|global-api-index)' || true)
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤ä¸å‰ä¸€ä¸ªæäº¤
          changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(yaml|yml)$' | grep -E '(docs/api|modules|domains|global-api-index)' || true)
        fi
        
        if [ -n "$changed_files" ]; then
          echo "å‘ç°APIæ–‡æ¡£æ–‡ä»¶å˜æ›´:"
          echo "$changed_files"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # å°†å˜æ›´æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$changed_files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "æœªå‘ç°APIæ–‡æ¡£æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: è¿è¡ŒåŸºç¡€APIæ–‡æ¡£éªŒè¯
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.validation_level == 'basic' || github.event.inputs.validation_level == 'full'
      working-directory: docs/api/4.5.1
      run: |
        echo "ğŸ” è¿è¡ŒåŸºç¡€APIæ–‡æ¡£éªŒè¯..."
        
        if [ -f "validate-api.py" ]; then
          python validate-api.py
        else
          echo "âš ï¸ åŸºç¡€éªŒè¯è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡åŸºç¡€éªŒè¯"
        fi
    
    - name: è¿è¡Œå¢å¼ºAPIæ–‡æ¡£éªŒè¯
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.validation_level == 'enhanced' || github.event.inputs.validation_level == 'full'
      working-directory: docs/api/4.5.1
      run: |
        echo "ğŸš€ è¿è¡Œä¸‰çº§APIæ–‡æ¡£è´¨é‡ä¿è¯éªŒè¯..."
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p reports
        
        # è¿è¡Œå¢å¼ºéªŒè¯
        python enhanced-api-validator.py --output reports/validation_report.json
    
    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always() && (steps.changes.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch')
      working-directory: docs/api/4.5.1
      run: |
        echo "ğŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
        
        # è¿è¡ŒCIè„šæœ¬ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
        if [ -f "ci-api-validation.sh" ]; then
          chmod +x ci-api-validation.sh
          ./ci-api-validation.sh || true
        fi
        
        # ç¡®ä¿æŠ¥å‘Šæ–‡ä»¶å­˜åœ¨
        if [ ! -f "reports/validation_report.json" ]; then
          echo "âš ï¸ éªŒè¯æŠ¥å‘Šä¸å­˜åœ¨ï¼Œç”Ÿæˆç©ºæŠ¥å‘Š"
          mkdir -p reports
          echo '{"summary": {"status": "no_report"}, "validation_results": []}' > reports/validation_report.json
        fi
    
    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-validation-report-${{ github.sha }}
        path: |
          docs/api/4.5.1/reports/
        retention-days: 30
    
    - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯Pull Requestï¼‰
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            // è¯»å–éªŒè¯æŠ¥å‘Š
            const reportPath = 'docs/api/4.5.1/reports/validation_report.json';
            let reportContent = 'éªŒè¯æŠ¥å‘Šä¸å¯ç”¨';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              // ç”ŸæˆPRè¯„è®ºå†…å®¹
              let comment = '## ğŸ” APIæ–‡æ¡£è´¨é‡éªŒè¯æŠ¥å‘Š\n\n';
              
              if (report.summary) {
                comment += '### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n';
                comment += `- æ¨¡å—æ–‡ä»¶æ•°é‡: ${report.summary.total_modules || 0}\n`;
                comment += `- ä¸šåŠ¡åŸŸæ–‡ä»¶æ•°é‡: ${report.summary.total_domains || 0}\n`;
                comment += `- å…¨å±€ç´¢å¼•APIæ•°é‡: ${report.summary.total_global_apis || 0}\n`;
                comment += `- æ˜ å°„è¦†ç›–ç‡: ${((report.summary.mapping_coverage_rate || 0) * 100).toFixed(1)}%\n\n`;
              }
              
              if (report.validation_results && report.validation_results.length > 0) {
                comment += '### ğŸ” éªŒè¯ç»“æœ\n';
                report.validation_results.forEach((result, index) => {
                  const status = result.success ? 'âœ…' : 'âŒ';
                  comment += `${index + 1}. ${status} ${result.message}\n`;
                });
                comment += '\n';
                
                // ç»Ÿè®¡é—®é¢˜æ•°é‡
                const totalIssues = report.validation_results
                  .filter(r => !r.success)
                  .reduce((sum, r) => sum + (r.details ? r.details.length : 0), 0);
                
                if (totalIssues > 0) {
                  comment += `âš ï¸ **å‘ç° ${totalIssues} ä¸ªé—®é¢˜éœ€è¦ä¿®å¤**\n\n`;
                  comment += 'è¯·æŸ¥çœ‹è¯¦ç»†çš„éªŒè¯æŠ¥å‘Šä»¥äº†è§£å…·ä½“é—®é¢˜ã€‚\n';
                } else {
                  comment += 'ğŸ‰ **æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ŒAPIæ–‡æ¡£æ¶æ„å®Œæ•´ï¼**\n';
                }
              }
              
              comment += '\n---\n';
              comment += `ğŸ“„ å®Œæ•´æŠ¥å‘Šè¯·æŸ¥çœ‹ [éªŒè¯æŠ¥å‘Šå·¥ä»¶](${context.payload.pull_request.html_url}/checks)\n`;
              
              reportContent = comment;
            }
            
            // å‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });
            
          } catch (error) {
            console.error('ç”ŸæˆPRè¯„è®ºå¤±è´¥:', error);
            
            // å‘å¸ƒç®€å•çš„é”™è¯¯è¯„è®º
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ” APIæ–‡æ¡£è´¨é‡éªŒè¯æŠ¥å‘Š\n\nâŒ éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—äº†è§£è¯¦æƒ…ã€‚'
            });
          }
    
    - name: è®¾ç½®éªŒè¯çŠ¶æ€
      if: always()
      run: |
        # æ£€æŸ¥éªŒè¯æ˜¯å¦æˆåŠŸ
        if [ -f "docs/api/4.5.1/reports/validation_report.json" ]; then
          # ä½¿ç”¨Pythonæ£€æŸ¥éªŒè¯ç»“æœ
          python3 << 'EOF'
import json
import sys

try:
    with open('docs/api/4.5.1/reports/validation_report.json', 'r') as f:
        report = json.load(f)
    
    validation_results = report.get('validation_results', [])
    all_success = all(result.get('success', False) for result in validation_results)
    
    if all_success:
        print("âœ… æ‰€æœ‰APIæ–‡æ¡£è´¨é‡æ£€æŸ¥é€šè¿‡")
        sys.exit(0)
    else:
        print("âŒ APIæ–‡æ¡£è´¨é‡æ£€æŸ¥å¤±è´¥")
        sys.exit(1)
        
except Exception as e:
    print(f"âŒ æ£€æŸ¥éªŒè¯ç»“æœå¤±è´¥: {e}")
    sys.exit(1)
EOF
        else
          echo "âŒ éªŒè¯æŠ¥å‘Šä¸å­˜åœ¨"
          exit 1
        fi
