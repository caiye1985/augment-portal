# REQ-018: 财务管理模块

**补充:** 财务管理模块是IT运维门户系统商业化运营的核心组件，实现与CRM模块和SLA管理模块的深度自动化集成。

## 1. 业务描述
管理收费、账单、付款和财务分析，直接支持商业化运营。高阶版财务模块需实现与 **CRM 模块（REQ-016）** 和 **SLA 管理模块（REQ-017）** 的**深度自动化集成**：
1. **合同驱动周期计费**：支持合同按月 / 按季度 / 按年自动生成账单，可叠加用量计费（工单费、增值服务费、SLA赔偿扣费）。
2. **权责发生制收入确认**：区分现金流入与收入确认，实现财务合规。
3. **合同展期机制**：合同即将到期或已到期时，在未签署新合同的情况下，可临时延长服务使用权（展期），避免因续签流程长导致停服。展期期间可灵活计费（按日、月折算、免费），结束后可自动切换到新合同或停服。
4. **智能风控**：基于 AI 分析客户历史付款、合同金额、SLA违约记录、CRM风险评级，提前识别高风险付款客户并推动催收。
5. **多渠道支付与对账**：支持支付宝、微信、银企直连、信用卡等支付方式，并自动对账。
6. **财务预测与结构分析**：结合合同周期结构，预测未来 12~24 个月的现金流高低谷、MRR、ARR，输出年付/季付/月付的比例及优化建议。

## 2. KPI / 核心目标
- 自动生成账单准确率 ≥ 99.9%
- 账单生成延迟 ≤ 1 分钟
- 财务对账差异率 ≤ 0.5%
- 高风险付款客户提前识别率 ≥ 90%
- 催收成功率 ≥ 85%
- 周期结构目标：年付客户 ≥ 40%，季付客户 ≤ 40%，月付客户 ≤ 30%（可调整）
- 预测目标：滚动12个月现金流预测偏差 ≤ 5%
- 展期执行准确率 = 100%
- 展期到生效耗时 ≤ 5 分钟（P95）
- 因合同到期停服导致的用户流失率 ≤ 1%

## 3. 功能需求表

| 功能编号 | 功能名称 | 描述 | 优先级 | KPI 关联 |
|---------|---------|------|--------|---------|
| F001 | 合同驱动计费 | 基于合同条款和 SLA 数据自动生成账单 | P0 | 准确率 |
| F002 | 多计费模式 | 支持固定费用、按用量（工单/小时/事件）、违约赔偿扣费 | P0 | 收入覆盖率 |
| F003 | 发票管理 | 电子发票申请、下载、税率设置 | P1 | 合规性 |
| F004 | 支付与对账 | 支持多渠道支付与自动对账 | P0 | 对账差异率 |
| F005 | 财务风控模型 | AI 预测付款风险并给出催收策略 | P1 | 催收成功率 |
| F006 | 账单通知与催收 | 自动推送账单到通知系统（REQ-011），高风险提前催收 | P0 | 高风险识别率 |
| F007 | 多币种与多税率 | 租户级货币、税率配置 | P2 | 全球化能力 |
| F008 | 合规与审计 | 财务操作留痕、账单溯源 | P0 | 审计覆盖率 |
| F009 | 财务预测与现金流分析 | 预测未来 12/24 个月现金流、MRR、ARR走势 | P1 | 预测偏差率 |
| F010 | 周期分布分析 | 分析付费周期结构，并输出优化建议 | P2 | 结构健康度 |
| F011 | 合同展期申请 | 合同到期前/后手动申请展期，避免停服 | P0 | 流失率 |
| F012 | 展期审批 | 按租户定义审批流，支持立即生效/审批生效 | P0 | 生效耗时 |
| F013 | 展期计费方式 | 展期期间按日、月折算或免费 | P0 | 收入准确率 |
| F014 | 展期记录关联 | 与原合同 & 新合同保持关联，便于追溯 | P0 | 审计准确率 |
| F015 | 到期提醒 | 到期前N天通知租户管理员，可引导展期 | P1 | 提前预警率 |
| F016 | 展期结束策略 | 到期后自动续费或停用 | P1 | 服务连续性 |

## 4. 用户故事
- 作为财务人员，我希望系统能根据合同周期自动生成账单并推送客户。
- 作为财务经理，我希望根据周期结构预测未来的现金流高峰和低谷，优化资金计划。
- 作为租户管理员，我希望在新合同审批未完成前使用展期功能，避免停用风险。
- 作为财务人员，我希望展期费用与后续合同周期衔接，计费准确。
- 作为系统管理员，我希望展期结束自动切换新合同或停用，避免漏控。
- 作为运营经理，我希望看到当前各付费周期客户占比，并能模拟调整后的现金流走势。
- 作为销售经理，我希望在推动年付客户比例时系统能生成预测ROI报告。

## 5. 用户交互与流程（正常流 / 异常流）

**正常流程：自动计费流程**
1. 系统定时扫描即将到期的计费周期
2. 根据合同条款计算基础费用
3. 从工单系统获取用量数据计算增量费用
4. 从SLA系统获取违约数据计算扣费
5. 生成账单并发送给客户
6. 记录账单状态和财务流水

**异常流程：合同展期处理**
1. 合同即将到期，系统发送提醒
2. 租户管理员申请展期
3. 系统根据配置进行审批流程
4. 审批通过后立即生效展期
5. 展期期间按配置计费或免费
6. 展期结束前提醒续约或自动停服

**补充:** 展期机制确保服务连续性，避免因合同流程导致的服务中断。

## 6. 非功能需求

**性能需求**
- **计费性能**：账单生成延迟≤1分钟，支持万级客户并发计费
- **查询性能**：财务报表查询响应时间≤5秒
- **对账性能**：支付对账处理时间≤10分钟
- **预测性能**：财务预测计算时间≤30秒

**准确性需求**
- **计费准确性**：自动计费准确率≥99.9%
- **对账准确性**：支付对账差异率≤0.5%
- **预测准确性**：现金流预测偏差≤5%
- **数据一致性**：财务数据与业务数据一致性≥99.9%

**安全性需求**
- **数据加密**：财务敏感数据加密存储和传输
- **访问控制**：基于角色的财务数据访问权限
- **审计追踪**：所有财务操作100%审计记录
- **合规要求**：符合财务法规和税务要求

## 7. 数据模型（字段级）

**invoice（账单表）**

| 字段名 | 类型 | 可空 | 描述 | 约束/索引 |
|--------|------|------|------|-----------|
| invoice_id | bigint | N | 账单ID | PK |
| tenant_id | bigint | N | 租户ID | idx_tenant |
| customer_id | bigint | N | 客户ID | idx_customer |
| amount | decimal(12,2) | N | 金额 |  |
| currency | varchar(10) | N | 货币 |  |
| tax_rate | decimal(5,2) | Y | 税率 |  |
| sla_penalty | decimal(12,2) | Y | SLA 违约赔偿金额 |  |
| status | varchar(20) | N | unpaid/paid/overdue | idx_status |
| due_date | date | N | 到期日 | idx_due |
| risk_level | varchar(20) | Y | 风险等级 | idx_risk |
| billing_cycle | varchar(20) | N | month/quarter/year |
| contract_start_date | date | N | 合同生效日期 |
| contract_end_date | date | N | 合同结束日期 |
| precharge_days | int | Y | 提前收款天数，默认0 |
| recognition_period | int | Y | 收入确认周期（月），年付可填12 |
| forecast_flag | boolean | N | 是否纳入预测模型 |
| created_at | timestamp | N | 创建时间 | idx_created |

**账单表（billing_invoices）**
```sql
CREATE TABLE billing_invoices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    invoice_no VARCHAR(50) UNIQUE NOT NULL COMMENT '账单编号',
    customer_id BIGINT NOT NULL COMMENT '客户ID',
    contract_id BIGINT COMMENT '合同ID',
    billing_period_start DATE NOT NULL COMMENT '计费周期开始',
    billing_period_end DATE NOT NULL COMMENT '计费周期结束',
    base_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '基础费用',
    usage_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '用量费用',
    penalty_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '违约扣费',
    discount_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '折扣金额',
    tax_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '税费',
    total_amount DECIMAL(12,2) NOT NULL COMMENT '总金额',
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '币种',
    status TINYINT DEFAULT 1 COMMENT '状态：1-待付款，2-已付款，3-已逾期，4-已取消',
    due_date DATE COMMENT '到期日期',
    paid_date DATETIME COMMENT '付款日期',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_customer (tenant_id, customer_id),
    INDEX idx_billing_period (billing_period_start, billing_period_end),
    INDEX idx_status_due_date (status, due_date)
);
```

**contract_extension（合同展期表）**

| 字段 | 类型 | 描述 |
|------|-----|------|
| extension_id | bigint | 展期ID |
| contract_id | bigint | 原合同ID |
| tenant_id | bigint | 租户ID |
| start_date | date | 展期起始日 |
| end_date | date | 展期结束日 |
| extension_type | varchar | daily_prorated / monthly / free |
| extension_fee | decimal | 展期费用 |
| approval_status | varchar | pending/approved/rejected |
| linked_new_contract_id | bigint | 新合同ID（生效后关联） |

**合同展期表（contract_extensions）**
```sql
CREATE TABLE contract_extensions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    contract_id BIGINT NOT NULL COMMENT '原合同ID',
    extension_start_date DATE NOT NULL COMMENT '展期开始日期',
    extension_end_date DATE NOT NULL COMMENT '展期结束日期',
    extension_days INT NOT NULL COMMENT '展期天数',
    billing_type TINYINT DEFAULT 1 COMMENT '计费方式：1-免费，2-按日，3-按月',
    daily_rate DECIMAL(10,2) COMMENT '日费率',
    total_amount DECIMAL(12,2) DEFAULT 0.00 COMMENT '展期总费用',
    approval_status TINYINT DEFAULT 1 COMMENT '审批状态：1-待审批，2-已批准，3-已拒绝',
    approved_by BIGINT COMMENT '审批人ID',
    approved_at DATETIME COMMENT '审批时间',
    status TINYINT DEFAULT 1 COMMENT '状态：1-生效中，2-已结束，3-已取消',
    created_by BIGINT NOT NULL COMMENT '申请人ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_contract (tenant_id, contract_id),
    INDEX idx_extension_period (extension_start_date, extension_end_date),
    INDEX idx_status (status)
);
```

## 8. 核心 API 示例

**生成账单API**
```http
POST /api/v1/billing/invoices/generate
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "customer_id": 12345,
    "billing_period_start": "2024-08-01",
    "billing_period_end": "2024-08-31",
    "force_regenerate": false
}

Response:
{
    "code": 200,
    "message": "账单生成成功",
    "data": {
        "invoice_id": 67890,
        "invoice_no": "INV202408110001",
        "total_amount": 12500.00,
        "base_amount": 10000.00,
        "usage_amount": 2000.00,
        "penalty_amount": 0.00,
        "tax_amount": 500.00,
        "due_date": "2024-09-10",
        "status": 1
    }
}
```

**申请合同展期API**
```http
POST /api/v1/contracts/12345/extensions
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "extension_days": 30,
    "billing_type": 2,
    "reason": "新合同审批中，申请临时展期",
    "auto_approve": false
}

Response:
{
    "code": 200,
    "message": "展期申请成功",
    "data": {
        "extension_id": 98765,
        "extension_start_date": "2024-09-01",
        "extension_end_date": "2024-09-30",
        "total_amount": 1000.00,
        "approval_status": 1,
        "estimated_approval_time": "2小时内"
    }
}
```

## 9. 异常与边界场景

**计费异常场景**
- **数据缺失**：用量数据缺失时，使用历史平均值或手动补录
- **计费错误**：计费公式错误时，提供错误检测和修正机制
- **重复计费**：防止重复生成账单，提供幂等性保证
- **币种转换**：汇率异常时，使用备用汇率源或手动设置

**展期异常场景**
- **展期冲突**：多个展期申请冲突时，按时间优先级处理
- **审批超时**：审批流程超时时，自动升级或紧急处理
- **展期失效**：展期期间合同变更时，自动调整展期条件
- **计费异常**：展期计费错误时，提供手动调整和补偿机制

## 10. 性能 / 容量规划

**数据容量规划**
- **账单数据**：年账单量100万张，每张约5KB，总计5GB
- **支付记录**：年支付记录200万条，每条约2KB，总计4GB
- **展期记录**：年展期记录1万条，每条约3KB，总计30MB
- **财务报表**：预计算报表数据约1GB，实时计算缓存500MB

**性能优化策略**
- **批量计费**：支持批量账单生成，提升计费效率
- **异步处理**：复杂财务计算异步处理，避免阻塞
- **缓存策略**：财务配置和汇率数据缓存
- **数据分区**：按时间和客户分区存储，提升查询性能

## 11. 安全与合规

**财务安全**
- **数据加密**：财务敏感数据AES-256加密存储
- **访问控制**：财务数据严格的角色权限控制
- **操作审计**：所有财务操作完整审计记录
- **数据备份**：财务数据实时备份，异地容灾

**合规要求**
- **税务合规**：支持各地税率和税务申报要求
- **财务准则**：符合企业会计准则和国际财务报告准则
- **审计要求**：提供完整的财务审计追踪
- **数据保护**：符合金融数据保护法规要求

## 12. 测试与验收标准

**功能测试**
- **计费测试**：测试各种计费模式的准确性
- **支付测试**：测试多渠道支付和对账功能
- **展期测试**：测试合同展期的完整流程
- **报表测试**：测试财务报表的生成和准确性

**性能测试**
- **计费性能**：测试大批量账单生成的性能
- **查询性能**：测试复杂财务查询的响应时间
- **并发测试**：测试多用户并发财务操作
- **数据一致性**：测试财务数据的一致性和完整性

## 13. 模块依赖

**依赖模块**
- **基础架构模块（REQ-001）**：用户认证、权限控制、数据存储
- **客户关系管理（REQ-016）**：客户信息、合同数据
- **SLA管理模块（REQ-017）**：SLA违约数据和赔偿计算
- **工单管理模块（REQ-003）**：工单用量数据
- **通知消息模块（REQ-011）**：账单通知、催收提醒

**被依赖模块**
- **数据分析模块（REQ-023）**：依赖财务数据进行业务分析
- **客户自助服务（REQ-019）**：为客户提供账单查询服务
- **系统管理模块（REQ-010）**：财务配置和参数管理

**外部依赖**
- **支付网关**：支付宝、微信、银联等支付接口
- **银行系统**：银企直连、对账文件接口
- **税务系统**：电子发票、税务申报接口
- **汇率服务**：实时汇率查询和转换服务
- **财务系统**：与企业ERP、财务系统集成
