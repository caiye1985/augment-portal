# REQ-021: 资源权限管理模块

**补充:** 资源权限管理模块为IT运维门户系统提供细粒度的资源访问控制，确保系统资源的安全性和合规性。

## 1. 业务描述
针对平台内的具体业务资源（如单条工单、知识库文章、资产记录、报表文件、配置项等）进行细粒度权限控制，确保用户只能访问有权操作的特定资源。该模块是 **用户与权限管理模块（REQ-022）** 的细化延伸，支持 **对象级 / 记录级 / 字段级** 权限管理，实现 **RBAC（基于角色）+ ABAC（基于属性）+ PBAC（基于策略）** 的组合式访问控制策略：
- **对象级**：某类资源的增删改查权限，例如：报表文件、工单
- **记录级**：同类资源中，限制只能访问自己创建或被授权的记录
- **字段级**：同一条记录中，仅能访问部分字段（如隐藏财务字段）

模块需支持多租户隔离、批量授权、临时授权、链路审计，并与**工单管理（REQ-003）**、**知识库（REQ-005）**、**财务管理（REQ-018）**等模块深度集成。

## 2. KPI / 核心目标
- 非授权访问阻断率 = 100%
- 权限变更生效延迟 ≤ 3 秒
- 多租户数据访问违规事件 **0 起**
- 授权配置错误率 ≤ 1%（人工复核比对）
- **系统性能**：权限验证响应时间≤100ms，不影响业务性能
- **审计完整性**：权限操作审计覆盖率100%，日志完整性100%

## 3. 功能需求表

| 功能编号 | 功能名称 | 优先级 | 功能描述 | 验收标准 |
|---------|----------|--------|----------|----------|
| REQ-021-001 | 对象级权限管理 | P0 | 模块级/资源类别级的 CRUD 权限配置 | 定义完整，分类清晰 |
| REQ-021-002 | 记录级权限管理 | P0 | 基于记录归属或属性动态授权 | 策略准确，执行高效 |
| REQ-021-003 | 字段级权限管理 | P0 | 限制查看或编辑特定字段 | 控制有效，响应及时 |
| REQ-021-004 | 多租户隔离策略 | P0 | 不同租户资源物理与逻辑隔离 | 操作准确，流程规范 |
| REQ-021-005 | 属性驱动权限（ABAC） | P1 | 根据用户、资源和环境属性动态决策授权 | 监控全面，告警及时 |
| REQ-021-006 | 权限模板与批量授权 | P1 | 权限集合快速分配/回收 | 审计完整，报告准确 |
| REQ-021-007 | 临时授权 | P1 | 指定有效期和范围的短期授权 | 授权灵活，控制严格 |
| REQ-021-008 | 链路审计 | P0 | 记录每一次资源访问请求（资源ID+用户+时间+结果） | 分析深入，建议有效 |

## 4. 用户故事

**故事1：安全管理员的权限配置**
- **角色**：安全管理员
- **需求**：作为安全管理员，我希望能够精确控制用户对系统资源的访问权限
- **场景**：定义资源权限策略，配置用户访问权限，监控权限使用情况
- **验收标准**：权限配置精确，策略执行有效，监控全面

**故事2：部门经理的权限申请**
- **角色**：部门经理
- **需求**：作为部门经理，我希望能够为团队成员申请必要的系统访问权限
- **场景**：提交权限申请，说明业务需求，等待审批和授权
- **验收标准**：申请流程清晰，审批及时，权限准确

**故事3：普通用户的资源访问**
- **角色**：普通用户
- **需求**：作为用户，我希望能够顺畅访问被授权的系统资源
- **场景**：登录系统，访问相关功能，完成工作任务
- **验收标准**：访问顺畅，权限准确，无误拦截

## 5. 用户交互与流程（正常流 / 异常流）

**正常流程：权限验证流程**
1. 用户发起资源访问请求
2. 系统提取用户身份和权限信息
3. 权限引擎根据策略进行权限验证
4. 验证通过，允许访问资源
5. 记录访问日志和审计信息
6. 返回资源访问结果

**异常流程：权限拒绝处理**
1. 用户访问未授权资源
2. 权限引擎检测到权限不足
3. 拒绝访问并记录安全事件
4. 向用户返回权限不足提示
5. 通知安全管理员异常访问
6. 提供权限申请入口
7. 分析访问模式，优化权限策略

**补充:** 智能的权限管理确保安全性和用户体验的平衡。

## 6. 非功能需求

**性能需求**
- **验证性能**：权限验证响应时间≤100ms
- **并发支持**：支持10000+并发权限验证
- **缓存效率**：权限缓存命中率≥95%
- **系统影响**：权限验证对业务性能影响≤5%

**安全需求**
- **访问控制**：100%的资源访问受权限控制
- **权限隔离**：不同租户权限严格隔离
- **数据保护**：权限数据加密存储和传输
- **审计完整性**：所有权限操作完整审计

**可靠性需求**
- **系统可用性**：权限系统可用性≥99.99%
- **数据一致性**：权限数据一致性≥99.9%
- **故障恢复**：权限系统故障恢复时间≤1分钟
- **备份保护**：权限数据实时备份

## 7. 数据模型（字段级）

**resource_permission（资源权限表）**

| 字段名 | 类型 | 可空 | 描述 | 约束/索引 |
|--------|------|------|------|-----------|
| perm_id | bigint | N | 权限记录ID | PK |
| tenant_id | bigint | N | 租户ID | idx_tenant |
| resource_type | varchar(50) | N | 资源类型（ticket, kb_article等） | idx_type |
| resource_id | varchar(100) | N | 资源唯一标识 | idx_resource |
| user_id | bigint | Y | 被授权用户ID | idx_user |
| role_id | bigint | Y | 被授权角色ID | idx_role |
| fields_allowed | jsonb | Y | 允许访问的字段列表 |  |
| conditions | jsonb | Y | ABAC属性条件 |  |
| valid_from | timestamp | Y | 授权开始时间 |  |
| valid_to | timestamp | Y | 授权结束时间 | idx_expiry |

**资源定义表（resources）**
```sql
CREATE TABLE resources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    resource_code VARCHAR(100) NOT NULL COMMENT '资源编码',
    resource_name VARCHAR(200) NOT NULL COMMENT '资源名称',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    parent_id BIGINT COMMENT '父资源ID',
    resource_path VARCHAR(500) COMMENT '资源路径',
    resource_attributes JSON COMMENT '资源属性',
    description TEXT COMMENT '资源描述',
    is_sensitive TINYINT DEFAULT 0 COMMENT '是否敏感资源',
    status TINYINT DEFAULT 1 COMMENT '状态：1-启用，2-禁用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_code (tenant_id, resource_code),
    INDEX idx_resource_type (resource_type),
    INDEX idx_parent_id (parent_id),
    INDEX idx_resource_path (resource_path)
);
```

**权限策略表（permission_policies）**
```sql
CREATE TABLE permission_policies (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    policy_name VARCHAR(100) NOT NULL COMMENT '策略名称',
    policy_type VARCHAR(50) NOT NULL COMMENT '策略类型：RBAC,ABAC',
    resource_pattern VARCHAR(500) NOT NULL COMMENT '资源匹配模式',
    subject_pattern VARCHAR(500) NOT NULL COMMENT '主体匹配模式',
    action_pattern VARCHAR(200) NOT NULL COMMENT '操作匹配模式',
    conditions JSON COMMENT '条件表达式',
    effect TINYINT NOT NULL COMMENT '效果：1-允许，2-拒绝',
    priority INT DEFAULT 0 COMMENT '优先级',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_type (tenant_id, policy_type),
    INDEX idx_resource_pattern (resource_pattern),
    INDEX idx_priority (priority),
    INDEX idx_enabled (enabled)
);
```

## 8. 核心 API 示例

**权限验证API**
```http
POST /api/v1/permissions/verify
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "subject": {
        "user_id": 1001,
        "roles": ["engineer", "senior_engineer"],
        "department": "ops_team",
        "attributes": {
            "security_level": "L2",
            "location": "beijing"
        }
    },
    "resource": {
        "resource_code": "ticket_management",
        "resource_type": "module",
        "attributes": {
            "data_classification": "internal",
            "customer_id": 12345
        }
    },
    "action": "read"
}

Response:
{
    "code": 200,
    "message": "权限验证完成",
    "data": {
        "allowed": true,
        "decision": "permit",
        "matched_policies": [
            {
                "policy_id": 1001,
                "policy_name": "工程师基础权限",
                "effect": "allow"
            }
        ],
        "conditions": {
            "time_limit": "09:00-18:00",
            "ip_restriction": false
        },
        "cache_ttl": 300
    }
}
```

**批量权限分配API**
```http
POST /api/v1/permissions/batch-assign
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "assignments": [
        {
            "user_id": 1001,
            "resource_codes": ["ticket_management", "knowledge_base"],
            "actions": ["read", "write"],
            "conditions": {
                "valid_until": "2024-12-31",
                "ip_restrictions": ["192.168.1.0/24"]
            }
        },
        {
            "user_id": 1002,
            "resource_codes": ["system_monitoring"],
            "actions": ["read"],
            "conditions": {
                "time_restrictions": "09:00-18:00"
            }
        }
    ],
    "reason": "新员工入职权限分配",
    "approver_id": 2001
}

Response:
{
    "code": 200,
    "message": "批量权限分配成功",
    "data": {
        "total_assignments": 2,
        "successful_assignments": 2,
        "failed_assignments": 0,
        "assignment_details": [
            {
                "user_id": 1001,
                "status": "success",
                "assigned_permissions": 4
            },
            {
                "user_id": 1002,
                "status": "success",
                "assigned_permissions": 1
            }
        ]
    }
}
```

## 9. 异常与边界场景

**权限异常场景**
- **权限冲突**：多个权限策略冲突时，按优先级和效果处理
- **权限过期**：临时权限过期时，自动回收并通知
- **策略错误**：权限策略配置错误时，提供验证和修正
- **缓存失效**：权限缓存失效时，实时查询并更新

**系统异常场景**
- **权限系统故障**：权限系统故障时，启用安全模式
- **数据不一致**：权限数据不一致时，提供同步和修复
- **性能问题**：权限验证性能问题时，优化策略和缓存
- **安全事件**：检测到安全威胁时，自动加强权限控制

## 10. 性能 / 容量规划

**数据容量规划**
- **资源数据**：支持10万+资源定义，每资源约5KB
- **权限策略**：支持1万+权限策略，每策略约10KB
- **权限分配**：支持100万+权限分配记录，每记录约2KB
- **审计日志**：年权限操作日志1000万条，每条约3KB

**性能优化策略**
- **权限缓存**：热点权限数据Redis缓存，提升验证速度
- **策略优化**：权限策略预编译和索引优化
- **批量处理**：权限批量操作，减少数据库访问
- **异步处理**：权限变更异步通知和同步

## 11. 安全与合规

**权限安全**
- **最小权限原则**：用户只获得完成工作所需的最小权限
- **权限分离**：关键操作需要多人授权或审批
- **定期审查**：定期审查和清理不必要的权限
- **权限监控**：实时监控权限使用和异常访问

**合规要求**
- **法规遵循**：符合数据保护和隐私法规要求
- **审计标准**：满足SOX、ISO27001等审计标准
- **行业规范**：遵循行业安全最佳实践
- **内控要求**：满足企业内控和风险管理要求

## 12. 测试与验收标准

**功能测试**
- **权限验证**：测试各种权限验证场景的准确性
- **策略执行**：测试权限策略的正确执行
- **权限管理**：测试权限分配、回收等管理功能
- **审计功能**：测试权限审计和日志记录

**安全测试**
- **权限绕过**：测试是否存在权限绕过漏洞
- **权限提升**：测试是否存在权限提升风险
- **数据泄露**：测试权限控制对数据泄露的防护
- **攻击防护**：测试对各种权限攻击的防护能力

## 13. 模块依赖

**依赖模块**
- **基础架构模块（REQ-001）**：用户认证、数据存储、缓存服务
- **用户与权限管理（REQ-022）**：用户身份和基础权限信息
- **系统管理模块（REQ-010）**：组织架构和角色管理
- **通知消息模块（REQ-011）**：权限变更通知和安全告警

**被依赖模块**
- **所有业务模块**：依赖资源权限管理进行访问控制
- **工单管理模块（REQ-003）**：工单数据的权限控制
- **知识库管理（REQ-005）**：知识内容的访问权限
- **财务管理模块（REQ-018）**：财务数据的权限保护

**外部依赖**
- **身份认证系统**：LDAP、AD、OAuth等身份认证服务
- **权限引擎**：Apache Ranger、Open Policy Agent等权限引擎
- **审计系统**：企业审计和合规管理系统
- **安全监控**：SIEM、SOC等安全监控平台
