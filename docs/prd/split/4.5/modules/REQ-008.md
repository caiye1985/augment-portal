# REQ-008: 系统设置

## 1. 业务描述

系统设置模块为IT运维门户系统提供全面的配置管理功能，包括系统参数配置、租户设置、业务规则配置、界面定制等。该模块支持多层级的配置管理，从全局系统配置到租户级别配置，再到用户个人配置，确保系统能够适应不同的业务场景和用户需求。通过标准化的配置管理流程，提升系统的灵活性和可维护性。

作为全局配置中心，统一提供参数管理、功能开关、合规与安全策略配置；支持多租户隔离配置、版本化管理、批量导入导出。对接灰度发布（按租户/用户/比例）、安全策略（密码复杂度/会话时长/IP白名单）、系统特性（多语言/主题），并提供REST API供外部系统操作与审计。

## 2. KPI / 核心目标

- **配置完整性**：系统配置覆盖率≥95%，配置项完整率100%
- **配置生效性**：配置变更生效时间≤30秒，生效成功率≥99%
- **操作便捷性**：配置操作响应时间≤2秒，界面友好度≥90%
- **配置安全性**：配置变更审计覆盖率100%，权限控制准确率100%
- **系统稳定性**：配置错误导致的系统故障率≤1%
- **用户满意度**：配置功能用户满意度≥4.5分
- **变更准确率**：≥99.9%
- **功能开关切换延迟**：≤5秒
- **灰度发布生效率**：≥99%

## 3. 功能需求表

| 功能编号 | 功能名称 | 优先级 | 功能描述 | 验收标准 |
|---------|----------|--------|----------|----------|
| REQ-008-001 | 系统参数配置 | P0 | 全局参数、性能参数、安全参数 | 配置全面，生效及时 |
| **重复说明** | **系统配置功能与REQ-010-004重复** | **注意** | **系统设置专注配置管理，系统管理专注运维管理** | **需要明确分工边界** |
| REQ-008-002 | 租户配置 | P0 | 租户级别设置、功能开关、限制配置 | 租户隔离，配置独立 |
| **重复说明** | **租户配置功能与REQ-001-006重复** | **注意** | **系统设置提供管理界面，基础架构提供底层能力** | **需要明确分工边界** |
| REQ-008-003 | 业务规则配置 | P0 | 工单规则、派单规则、SLA规则 | 规则灵活，执行准确 |
| REQ-008-004 | 界面定制 | P1 | 主题设置、布局配置、菜单定制 | 定制灵活，效果美观 |
| REQ-008-005 | 通知配置 | P1 | 通知规则、模板管理、渠道设置 | 通知及时，模板丰富 |
| REQ-008-006 | 集成配置 | P1 | 第三方系统、API配置、数据同步 | 集成稳定，配置简便 |
| REQ-008-007 | 备份恢复 | P1 | 配置备份、恢复功能、版本管理 | 备份完整，恢复可靠 |
| REQ-008-008 | 配置审计 | P2 | 变更记录、操作日志、合规检查 | 审计完整，合规达标 |
| REQ-008-009 | 功能开关管理 | P0 | 启用/禁用模块与功能点 | 切换延迟≤5秒 |
| REQ-008-010 | 灰度发布策略 | P1 | 按租户/用户/比例启用 | 生效率≥99% |
| REQ-008-011 | 安全策略配置 | P0 | 密码复杂度/会话时长/IP 白名单 | 合规达标 |
| REQ-008-012 | 合规策略管理 | P1 | 数据留存周期/日志审计要求 | 覆盖100% |
| REQ-008-013 | 配置版本管理 | P1 | 记录变更，支持一键回滚 | 变更可追溯 |
| REQ-008-014 | 配置导入导出 | P2 | Excel/JSON 批量操作 | 模板校验与错误清单 |
| REQ-008-015 | 配置变更通知 | P1 | 实时通知受影响模块 | 推送延迟≤5秒 |

## 4. 用户故事

**作为系统管理员**，我希望能够统一管理系统的各项配置参数，以便快速调整系统行为适应业务需求。

**作为租户管理员**，我希望能够独立配置本租户的业务规则和界面设置，以便为用户提供个性化的服务体验。

**作为运维人员**，我希望能够通过配置管理实现功能的灰度发布和快速回滚，以便降低系统变更风险。

## 5. 用户交互与流程

### 5.1 正常流程

1. **配置查看**：用户登录→选择配置模块→查看当前配置列表→筛选/搜索目标配置
2. **配置修改**：选择配置项→编辑配置值→验证配置格式→预览影响范围→确认保存
3. **配置生效**：系统验证权限→保存配置→推送变更通知→更新缓存→记录审计日志

### 5.2 异常流程

- **值不合规**：拒绝保存并提示具体错误信息
- **推送失败**：加入重试队列并发送告警通知
- **配置冲突**：生成冲突清单并要求人工确认处理方案

### 5.3 生效机制

- **生效范围**：全局/模块/功能
- **生效模式**：即时生效/定时生效

## 6. 非功能需求

- **性能要求**：配置查询响应时间≤2秒，配置更新响应时间≤5秒
- **可用性要求**：系统可用性≥99.99%
- **安全要求**：所有配置变更必须经过权限验证和审计记录
- **推送延迟**：配置变更推送延迟≤5秒
- **并发支持**：支持100个并发用户同时进行配置操作

## 7. 数据模型

### 7.1 system_config（系统配置表）

| 字段名 | 类型 | 可空 | 描述 | 约束/索引 |
|--------|------|------|------|-----------|
| config_id | bigint | N | 配置ID | PK |
| tenant_id | bigint | Y | 租户ID（为空则为全局配置） | idx_tenant |
| config_key | varchar(255) | N | 配置键 | uniq_tenant_key |
| config_value | text | N | 配置值 |  |
| scope | varchar(20) | N | 配置范围：global/module/feature |  |
| effective_mode | varchar(20) | N | 生效模式：immediate/scheduled |  |
| version | int | N | 配置版本 | idx_version |
| created_by | bigint | N | 创建人ID | FK |
| updated_by | bigint | N | 更新人ID | FK |
| created_at | timestamp | N | 创建时间 | idx_created |
| updated_at | timestamp | N | 更新时间 | idx_updated |

### 7.2 config_change_logs（配置变更日志表）

| 字段名 | 类型 | 可空 | 描述 | 约束/索引 |
|--------|------|------|------|-----------|
| log_id | bigint | N | 日志ID | PK |
| config_id | bigint | N | 配置ID | FK |
| tenant_id | bigint | Y | 租户ID | idx_tenant |
| old_value | text | Y | 变更前值 |  |
| new_value | text | N | 变更后值 |  |
| operation_type | varchar(20) | N | 操作类型：CREATE/UPDATE/DELETE |  |
| operator_id | bigint | N | 操作人ID | FK |
| operation_time | timestamp | N | 操作时间 | idx_operation_time |
| ip_address | varchar(45) | Y | 操作IP地址 |  |
| user_agent | varchar(500) | Y | 用户代理信息 |  |

## 8. 核心API示例

### 8.1 获取配置列表
```http
GET /api/v1/system-config?scope=global&tenantId=123
```

### 8.2 更新配置
```http
PUT /api/v1/system-config/{configKey}
{
  "value": "3600",
  "scope": "global",
  "effectiveMode": "immediate"
}
```

### 8.3 批量更新配置
```http
POST /api/v1/system-config/batch
{
  "configs": [
    {
      "key": "session.timeout",
      "value": "3600",
      "scope": "global"
    }
  ]
}
```

**错误码定义**：
- 40001：配置值非法
- 40401：配置项不存在
- 40901：配置冲突
- 50001：保存失败

## 9. 异常与边界场景

- **配置值格式错误**：系统应验证配置值格式，拒绝非法值并提供明确错误提示
- **并发修改冲突**：多用户同时修改同一配置时，采用乐观锁机制处理冲突
- **配置依赖检查**：修改配置前检查是否影响其他配置项，避免系统异常
- **权限边界**：严格控制用户只能修改有权限的配置项
- **配置回滚失败**：当配置回滚失败时，提供手动修复机制

## 10. 性能/容量规划

- **配置数量**：支持10万个配置项
- **并发用户**：支持100个并发用户
- **历史版本**：保存配置历史版本≥3年
- **推送性能**：每秒推送≥1000项配置变更
- **存储策略**：采用冷热分层存储，热数据快速访问

## 11. 安全与合规

- **数据加密**：敏感配置采用AES-256加密存储
- **传输安全**：使用TLS 1.3加密传输
- **访问控制**：基于RBAC的细粒度权限控制
- **审计要求**：变更审计包含操作者/时间/前后值
- **合规检查**：配置变更符合企业安全策略

## 12. 测试与验收标准

- **功能测试**：覆盖所有配置管理功能点
- **性能测试**：验证响应时间和并发处理能力
- **安全测试**：权限控制和数据加密验证
- **专项测试**：功能开关/灰度发布/版本回滚专项用例
- **集成测试**：与其他模块的集成验证

## 13. 模块依赖

**上游依赖**：
- REQ-003（用户权限管理）：权限验证
- REQ-004（租户管理）：租户隔离

**下游依赖**：
- REQ-017（系统监控）：配置变更监控
- REQ-011（通知中心）：配置变更通知

**平级协作**：
- 与所有业务模块：提供配置服务
