# REQ-022: 用户与权限管理模块

**补充:** 用户与权限管理模块为IT运维门户系统提供全面的用户生命周期管理和基础权限控制功能。

## 1. 业务描述
提供多租户用户账户、角色、权限的集中管理能力，保障系统功能和数据安全。用户与权限管理模块是 IT 运维门户的身份认证与访问控制核心，实现用户生命周期管理（创建、启用/禁用、离职/删除）、角色与权限配置、单点登录（SSO）、访问审计等能力。模块需支持多租户架构下的严格数据隔离、跨租户账号独立性。提供**基于角色（RBAC）**和**细粒度权限（ABAC）**组合的访问控制方案，可与外部身份源（LDAP、AD、OAuth 2.0、OIDC、SAML）集成，支持 MFA（多因素认证）。

## 2. KPI / 核心目标
- 多租户用户数据隔离事件 **0 起**
- 用户权限配置错误率 ≤ 1%
- 登录认证平均延迟 ≤ 500ms（P95）
- 账号生命周期事件记录覆盖率 100%
- **安全合规**：密码策略合规率100%，账户安全事件零发生
- **用户体验**：用户登录体验满意度≥4.5分，操作便捷性≥90%

## 3. 功能需求表

| 功能编号 | 功能名称 | 优先级 | 功能描述 | 验收标准 |
|---------|----------|--------|----------|----------|
| REQ-022-001 | 用户生命周期管理 | P0 | 用户注册、激活、禁用、删除 | 流程完整，状态准确 |
| REQ-022-002 | 身份认证 | P0 | 多因子认证、SSO、LDAP集成 | 认证安全，集成稳定 |
| REQ-022-003 | 角色权限管理 | P0 | 角色定义、权限分配、继承关系 | 权限准确，管理便捷 |
| REQ-022-004 | 组织架构管理 | P0 | 部门管理、层级关系、人员分配 | 结构清晰，管理灵活 |
| REQ-022-005 | 外部身份源集成 | P1 | 支持 LDAP/AD/OAuth2/OIDC/SAML | 策略严格，流程安全 |
| REQ-022-006 | 单点登录(SSO) | P1 | 跨系统统一身份认证 | 控制有效，安全可靠 |
| REQ-022-007 | 多因素认证(MFA) | P1 | OTP/SMS/Email 安全码 | 画像准确，分析有效 |
| REQ-022-008 | 访问审计日志 | P0 | 登录、权限变更、操作记录 | 日志完整，审计准确 |
| REQ-022-009 | 会话管理 | P1 | 查看/强制下线用户会话 | 控制有效，安全可靠 |
| REQ-022-010 | 权限模板 | P2 | 常用岗位权限集合快速分配 | 配置高效，管理便捷 |

## 4. 用户故事

**故事1：系统管理员的用户管理**
- **角色**：系统管理员
- **需求**：作为管理员，我希望能够高效管理用户账户和权限分配
- **场景**：创建新用户账户，分配角色权限，管理组织架构，监控用户活动
- **验收标准**：管理功能完善，操作便捷，权限控制准确

**故事2：HR管理员的组织管理**
- **角色**：HR管理员
- **需求**：作为HR管理员，我希望能够维护组织架构和人员信息
- **场景**：创建部门结构，分配人员到部门，管理人员变动，同步HR系统
- **验收标准**：组织结构清晰，人员管理准确，同步及时

**故事3：普通用户的账户管理**
- **角色**：普通用户
- **需求**：作为用户，我希望能够安全便捷地登录系统和管理个人账户
- **场景**：登录系统，修改个人信息，重置密码，查看权限范围
- **验收标准**：登录便捷，信息管理简单，安全性高

## 5. 用户交互与流程（正常流 / 异常流）

**正常流程：用户登录认证流程**
1. 用户输入用户名和密码
2. 系统验证用户凭据
3. 检查用户状态和权限
4. 执行多因子认证（如需要）
5. 创建用户会话
6. 返回认证成功结果
7. 记录登录日志

**异常流程：认证失败处理**
1. 用户认证失败
2. 记录失败尝试次数
3. 检查是否达到锁定阈值
4. 如达到阈值，锁定账户
5. 发送安全告警通知
6. 提供账户解锁流程
7. 分析失败原因并优化

**补充:** 多层次的安全机制确保用户账户的安全性。

## 6. 非功能需求

**性能需求**
- **认证性能**：用户认证响应时间≤2秒
- **查询性能**：用户信息查询响应时间≤1秒
- **并发支持**：支持5000+并发用户登录
- **批量操作**：支持1000+用户的批量操作

**安全需求**
- **密码安全**：强密码策略，密码加密存储
- **会话安全**：安全的会话管理和超时控制
- **传输安全**：所有认证数据加密传输
- **审计完整性**：完整的用户操作审计日志

**可靠性需求**
- **系统可用性**：用户管理系统可用性≥99.9%
- **数据一致性**：用户数据一致性≥99.9%
- **备份恢复**：用户数据定期备份，快速恢复
- **故障切换**：支持主备切换和负载均衡

## 7. 数据模型（字段级）

**user_account（用户账号表）**

| 字段名 | 类型 | 可空 | 描述 | 约束/索引 |
|--------|------|------|------|-----------|
| user_id | bigint | N | 用户ID | PK |
| tenant_id | bigint | N | 租户ID | idx_tenant |
| username | varchar(100) | N | 登录名 | uniq_tenant_username |
| email | varchar(255) | Y | 邮箱 | idx_email |
| phone | varchar(20) | Y | 手机号 | idx_phone |
| password_hash | varchar(255) | N | 加密后的密码 |  |
| status | varchar(20) | N | active/inactive | idx_status |
| created_at | timestamp | N | 创建时间 | idx_created |
| updated_at | timestamp | N | 更新时间 | idx_updated |

**用户表（users）**
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    employee_id VARCHAR(50) COMMENT '员工编号',
    department_id BIGINT COMMENT '部门ID',
    position VARCHAR(100) COMMENT '职位',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    salt VARCHAR(50) NOT NULL COMMENT '密码盐值',
    password_updated_at DATETIME COMMENT '密码更新时间',
    last_login_time DATETIME COMMENT '最后登录时间',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    failed_login_count INT DEFAULT 0 COMMENT '失败登录次数',
    locked_until DATETIME COMMENT '锁定到期时间',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-禁用，3-锁定',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_username (tenant_id, username),
    UNIQUE KEY uk_tenant_email (tenant_id, email),
    INDEX idx_department_id (department_id),
    INDEX idx_status (status),
    INDEX idx_employee_id (employee_id)
);
```

**角色表（roles）**
```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    role_code VARCHAR(50) NOT NULL COMMENT '角色编码',
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    role_type TINYINT DEFAULT 1 COMMENT '角色类型：1-系统角色，2-业务角色',
    parent_id BIGINT COMMENT '父角色ID',
    description TEXT COMMENT '角色描述',
    permissions JSON COMMENT '权限列表',
    is_default TINYINT DEFAULT 0 COMMENT '是否默认角色',
    status TINYINT DEFAULT 1 COMMENT '状态：1-启用，2-禁用',
    created_by BIGINT NOT NULL COMMENT '创建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_code (tenant_id, role_code),
    INDEX idx_role_type (role_type),
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status)
);
```

## 8. 核心 API 示例

**用户登录API**
```http
POST /api/v1/auth/login
Content-Type: application/json

{
    "username": "engineer001",
    "password": "SecurePassword123!",
    "tenant_code": "company_a",
    "remember_me": true,
    "captcha": "ABCD",
    "captcha_token": "cap_token_123"
}

Response:
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "expires_in": 7200,
        "user_info": {
            "user_id": 1001,
            "username": "engineer001",
            "real_name": "张工程师",
            "email": "engineer001@company.com",
            "department": "运维部",
            "roles": ["engineer", "senior_engineer"],
            "permissions": ["ticket:read", "ticket:write", "knowledge:read"]
        },
        "mfa_required": false,
        "password_expires_in": 30
    }
}
```

**创建用户API**
```http
POST /api/v1/users
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "username": "newuser001",
    "email": "newuser@company.com",
    "phone": "13800138000",
    "real_name": "新用户",
    "employee_id": "EMP001",
    "department_id": 1001,
    "position": "初级工程师",
    "roles": ["engineer"],
    "password": "TempPassword123!",
    "force_password_change": true,
    "send_welcome_email": true
}

Response:
{
    "code": 200,
    "message": "用户创建成功",
    "data": {
        "user_id": 1002,
        "username": "newuser001",
        "status": "active",
        "initial_password_sent": true,
        "activation_required": false,
        "created_at": "2024-08-11 14:30:00"
    }
}
```

## 9. 异常与边界场景

**认证异常场景**
- **密码错误**：多次密码错误时，逐步增加锁定时间
- **账户锁定**：账户锁定时，提供解锁申请流程
- **会话过期**：会话过期时，提供无感刷新机制
- **并发登录**：检测异常并发登录，提供安全提醒

**权限异常场景**
- **权限冲突**：多个角色权限冲突时，按优先级处理
- **权限过期**：临时权限过期时，自动回收并通知
- **角色变更**：用户角色变更时，实时更新权限
- **组织变更**：组织架构变更时，自动调整用户归属

## 10. 性能 / 容量规划

**数据容量规划**
- **用户数据**：支持10万+用户，每用户约10KB基础信息
- **角色数据**：支持1000+角色，每角色约5KB权限信息
- **会话数据**：支持1万+并发会话，每会话约2KB
- **审计日志**：年登录日志1000万条，每条约3KB

**性能优化策略**
- **用户缓存**：活跃用户信息Redis缓存，提升查询速度
- **权限缓存**：用户权限信息缓存，减少权限查询
- **会话优化**：分布式会话存储，支持水平扩展
- **数据库优化**：用户表分区和索引优化

## 11. 安全与合规

**身份安全**
- **强认证**：支持多因子认证，提升账户安全
- **密码策略**：强制密码复杂度和定期更换
- **会话保护**：安全的会话管理和超时控制
- **异常检测**：检测异常登录行为和安全威胁

**数据保护**
- **敏感数据加密**：密码、个人信息等敏感数据加密
- **传输安全**：所有认证数据HTTPS传输
- **访问控制**：严格的用户数据访问权限控制
- **审计合规**：完整的用户操作审计追踪

## 12. 测试与验收标准

**功能测试**
- **用户管理**：测试用户生命周期管理的各项功能
- **认证功能**：测试各种认证方式的正确性
- **权限管理**：测试角色权限分配和继承
- **组织管理**：测试组织架构管理功能

**安全测试**
- **认证安全**：测试认证机制的安全性
- **权限控制**：测试权限控制的有效性
- **会话安全**：测试会话管理的安全性
- **数据保护**：测试敏感数据的保护措施

## 13. 模块依赖

**依赖模块**
- **基础架构模块（REQ-001）**：数据存储、缓存服务、消息队列
- **系统设置模块（REQ-008）**：系统配置和安全策略
- **通知消息模块（REQ-011）**：用户通知和安全告警

**被依赖模块**
- **所有业务模块**：依赖用户认证和权限验证
- **资源权限管理（REQ-021）**：提供用户身份和基础权限
- **工程师管理（REQ-006A/006B）**：用户基础信息管理
- **系统管理模块（REQ-010）**：系统级用户和权限管理

**外部依赖**
- **身份提供商**：LDAP、Active Directory、OAuth提供商
- **多因子认证**：短信服务、邮件服务、TOTP应用
- **单点登录**：SAML、CAS、OAuth2.0 SSO系统
- **审计系统**：企业审计和合规管理平台
