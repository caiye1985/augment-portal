# REQ-001: 基础架构模块 (v4.5.1)

## 版本变更说明
**版本：** 4.5.1  
**更新日期：** 2025-08-14  
**主要变更：**
- 完善RBAC权限模型，新增权限表、用户角色关联表、角色权限关联表
- 设计完整的会话管理机制，包括会话表和相关API
- 明确多租户数据隔离的技术实现方案
- 补充用户、角色、权限管理的完整CRUD API
- 新增审计日志系统和配置管理的完整数据模型
- 明确与REQ-008模块的功能边界分工
- 完善跨模块集成接口定义和批量操作API

## 1. 业务描述
基础架构模块是整个IT运维门户系统的技术底座，提供多租户架构、统一认证、权限管理、数据存储等核心基础服务。该模块确保系统的安全性、可扩展性和高可用性，支持一个平台服务多个客户的SaaS业务模式。模块采用微服务架构设计，支持水平扩展和弹性伸缩，为上层业务模块提供稳定可靠的技术支撑。

**v4.5.1增强：** 本版本重点完善了RBAC权限模型、会话管理机制、审计日志系统，并明确了多租户数据隔离的技术实现方案，确保系统的安全性和合规性达到企业级标准。

## 2. KPI / 核心目标
- **系统可用性**：99.9%以上的服务可用性，年度停机时间不超过8.76小时
- **响应性能**：API响应时间P95≤200ms，P99≤500ms
- **并发支持**：支持10,000+并发用户，单租户支持1,000+并发
- **数据安全**：零数据泄露事件，通过等保三级认证
- **扩展性能**：支持1,000+租户，单租户支持100,000+用户
- **认证效率**：用户登录响应时间≤3秒，SSO认证成功率≥99.5%
- **权限控制精度**：支持API级别的细粒度权限控制，权限验证响应时间≤50ms
- **审计完整性**：100%操作审计覆盖率，审计日志查询响应时间≤2秒

## 3. 功能需求表

| 功能编号 | 功能名称 | 优先级 | 功能描述 | 验收标准 |
|---------|----------|--------|----------|----------|
| REQ-001-001 | 多租户架构 | P0 | 数据隔离、资源隔离、配置隔离 | 租户间数据完全隔离，支持1000+租户 |
| REQ-001-002 | 统一认证 | P0 | 用户登录、密码管理、会话管理 | 支持多种认证方式，登录成功率≥99% |
| REQ-001-003 | RBAC权限管理 | P0 | 完整的角色权限控制、资源访问控制 | 权限控制精确到API级别，支持权限继承 |
| REQ-001-004 | 数据存储 | P0 | 关系型数据库、缓存、文件存储 | 数据一致性、高可用性 |
| REQ-001-005 | API网关 | P0 | 请求路由、限流、监控 | API响应时间≤200ms |
| REQ-001-006 | 配置管理 | P1 | 系统配置、租户配置、动态配置 | 配置变更实时生效 |
| **功能边界说明** | **与REQ-008分工明确** | **说明** | **基础架构提供配置存储和API，系统设置提供管理界面** | **接口契约明确定义** |
| REQ-001-007 | 监控告警 | P1 | 系统监控、性能监控、异常告警 | 故障发现时间≤3分钟 |
| REQ-001-008 | 审计日志管理 | P1 | 操作日志、审计日志、错误日志 | 日志完整性、可追溯性，支持合规审计 |
| REQ-001-009 | 高级认证协议 | P0 | 支持 OAuth2.0、OIDC、SAML等企业级认证协议 | 企业SSO集成成功率≥99% |
| REQ-001-010 | 消息与事件总线 | P1 | 跨模块异步通信（RabbitMQ），事件溯源 | 解耦、可靠性 |
| REQ-001-011 | 灾备与容灾 | P1 | 多活部署，RTO≤30分钟，RPO≤5分钟 | 高可用性 |
| REQ-001-012 | 动态伸缩 | P2 | 基于负载自动扩/缩容 | 性能成本比 |
| REQ-001-013 | 会话管理 | P0 | 用户会话控制、并发登录管理、会话安全 | 支持单点登录，会话超时自动清理 |
| REQ-001-014 | 批量操作支持 | P1 | 用户批量导入导出、权限批量分配 | 支持万级数据批量处理 |

## 4. 用户故事

**故事1：租户管理员的多租户体验**
- **角色**：租户管理员
- **需求**：作为租户管理员，我希望能够独立管理自己租户的用户和数据，不受其他租户影响
- **场景**：登录系统后只能看到自己租户的数据，无法访问其他租户信息
- **验收标准**：数据完全隔离，界面只显示当前租户相关内容

**故事2：系统管理员的统一管理**
- **角色**：系统管理员
- **需求**：作为系统管理员，我希望能够统一管理所有租户，监控系统整体运行状态
- **场景**：通过管理后台查看所有租户状态，进行系统级配置和维护
- **验收标准**：具备跨租户管理权限，能够查看系统全局状态

**故事3：普通用户的便捷登录**
- **角色**：普通用户
- **需求**：作为普通用户，我希望能够快速安全地登录系统，支持多种认证方式
- **场景**：使用用户名密码、手机验证码、企业SSO等方式登录
- **验收标准**：登录过程简单快捷，支持记住登录状态

**故事4：安全管理员的审计需求（新增）**
- **角色**：安全管理员
- **需求**：作为安全管理员，我希望能够查看所有用户的操作记录，确保系统安全合规
- **场景**：查询特定时间段内的用户操作日志，分析异常行为
- **验收标准**：审计日志完整准确，支持多维度查询和导出

## 5. 用户交互与流程（正常流 / 异常流）

**正常流程：用户登录认证**
1. 用户访问系统登录页面
2. 选择认证方式（用户名密码/手机验证码/SSO）
3. 输入认证信息
4. 系统验证用户身份和权限
5. 生成访问令牌和会话记录
6. 跳转到用户工作台

**正常流程：权限验证（新增）**
1. 用户发起API请求
2. API网关提取用户令牌
3. 调用权限验证服务
4. 基于RBAC模型验证用户权限
5. 返回权限验证结果
6. 允许或拒绝API访问

**异常流程：认证失败处理**
1. 用户输入错误的认证信息
2. 系统返回认证失败提示
3. 记录失败尝试次数和审计日志
4. 超过限制次数后锁定账户
5. 发送安全告警通知
6. 提供账户解锁和密码重置选项

**异常流程：多租户数据泄露防护（新增）**
1. 检测到跨租户数据访问尝试
2. 立即阻断请求并记录安全事件
3. 触发安全告警机制
4. 记录详细的审计日志
5. 通知安全管理员进行调查

## 6. 非功能需求

**性能需求**
- **响应时间**：API响应时间P95≤200ms，P99≤500ms
- **权限验证性能**：权限验证响应时间≤50ms
- **吞吐量**：支持10,000 QPS，峰值支持50,000 QPS
- **并发用户**：支持10,000+并发用户在线
- **数据处理**：支持TB级数据存储和查询
- **会话管理性能**：支持100,000+活跃会话并发管理

**可用性需求**
- **系统可用性**：99.9%（年度停机时间≤8.76小时）
- **故障恢复**：RTO≤30分钟，RPO≤5分钟
- **容灾备份**：支持异地容灾，数据实时同步
- **会话容错**：会话服务故障时自动降级，不影响核心功能

**安全性需求**
- **数据加密**：传输加密（TLS 1.3）、存储加密（AES-256）
- **访问控制**：基于RBAC的细粒度权限控制，支持API级别权限
- **审计合规**：完整的操作审计日志，支持等保三级
- **会话安全**：会话劫持防护，异常登录检测

**可扩展性需求**
- **水平扩展**：支持服务实例动态扩缩容
- **存储扩展**：支持数据库分库分表，存储容量线性扩展
- **租户扩展**：支持1,000+租户，单租户支持100,000+用户
- **权限模型扩展**：支持自定义权限资源和动作定义

## 7. 数据模型（字段级）

**v4.5.1重大更新：** 完善了RBAC权限模型、会话管理、审计日志和配置管理的完整数据模型设计。

### 7.1 多租户基础表

**租户表（tenants）**
```sql
CREATE TABLE tenants (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_code VARCHAR(50) UNIQUE NOT NULL COMMENT '租户编码',
    tenant_name VARCHAR(100) NOT NULL COMMENT '租户名称',
    domain VARCHAR(100) UNIQUE COMMENT '租户域名',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-停用，3-过期',
    max_users INT DEFAULT 100 COMMENT '最大用户数',
    max_storage_gb INT DEFAULT 10 COMMENT '最大存储空间(GB)',
    expire_time DATETIME COMMENT '过期时间',
    config JSON COMMENT '租户配置',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME NULL COMMENT '软删除时间',
    created_by BIGINT COMMENT '创建人',
    updated_by BIGINT COMMENT '更新人',
    INDEX idx_status (status),
    INDEX idx_expire_time (expire_time),
    INDEX idx_deleted_at (deleted_at)
);
```

**用户表（users）**
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    password_hash VARCHAR(255) COMMENT '密码哈希',
    real_name VARCHAR(50) COMMENT '真实姓名',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-停用，3-锁定',
    last_login_time DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(45) COMMENT '最后登录IP',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    failed_login_count INT DEFAULT 0 COMMENT '失败登录次数',
    password_expire_time DATETIME COMMENT '密码过期时间',
    mfa_enabled TINYINT DEFAULT 0 COMMENT '是否启用多因子认证',
    mfa_secret VARCHAR(255) COMMENT 'MFA密钥',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME NULL COMMENT '软删除时间',
    UNIQUE KEY uk_tenant_username (tenant_id, username),
    UNIQUE KEY uk_tenant_email (tenant_id, email),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_status (status),
    INDEX idx_deleted_at (deleted_at),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

### 7.2 RBAC权限模型表（新增完整设计）

**角色表（roles）**
```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    role_code VARCHAR(50) NOT NULL COMMENT '角色编码',
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    description TEXT COMMENT '角色描述',
    is_system TINYINT DEFAULT 0 COMMENT '是否系统角色',
    parent_role_id BIGINT NULL COMMENT '父角色ID，支持角色继承',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-停用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME NULL COMMENT '软删除时间',
    UNIQUE KEY uk_tenant_code (tenant_id, role_code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_parent_role_id (parent_role_id),
    INDEX idx_deleted_at (deleted_at),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (parent_role_id) REFERENCES roles(id)
);
```

**权限表（permissions）**
```sql
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) UNIQUE NOT NULL COMMENT '权限编码',
    permission_name VARCHAR(100) NOT NULL COMMENT '权限名称',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型：api,menu,button,data',
    resource_path VARCHAR(200) COMMENT '资源路径',
    action VARCHAR(50) NOT NULL COMMENT '操作：read,write,delete,execute',
    description TEXT COMMENT '权限描述',
    is_system TINYINT DEFAULT 1 COMMENT '是否系统权限',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_resource_type (resource_type),
    INDEX idx_action (action)
);
```

**角色权限关联表（role_permissions）**
```sql
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    granted TINYINT DEFAULT 1 COMMENT '是否授权：1-授权，0-拒绝',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT COMMENT '创建人',
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
);
```

**用户角色关联表（user_roles）**
```sql
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    granted_by BIGINT COMMENT '授权人',
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
    expires_at DATETIME NULL COMMENT '权限过期时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
);
```

### 7.3 会话管理表（新增）

**用户会话表（user_sessions）**
```sql
CREATE TABLE user_sessions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(128) UNIQUE NOT NULL COMMENT '会话ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    device_type VARCHAR(20) DEFAULT 'web' COMMENT '设备类型：web,mobile,api',
    device_info JSON COMMENT '设备信息',
    ip_address VARCHAR(45) NOT NULL COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    location VARCHAR(100) COMMENT '登录地点',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    last_accessed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '最后访问时间',
    expires_at DATETIME NOT NULL COMMENT '过期时间',
    status TINYINT DEFAULT 1 COMMENT '状态：1-活跃，2-过期，3-注销，4-异常',
    logout_reason VARCHAR(50) COMMENT '注销原因：manual,timeout,security,admin',
    INDEX idx_user_id (user_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_session_id (session_id),
    INDEX idx_expires_at (expires_at),
    INDEX idx_status (status),
    INDEX idx_last_accessed_at (last_accessed_at),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

### 7.4 审计日志表（新增）

**审计日志表（audit_logs）**
```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    user_id BIGINT NULL COMMENT '操作用户ID',
    session_id VARCHAR(128) COMMENT '会话ID',
    action VARCHAR(100) NOT NULL COMMENT '操作动作',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源ID',
    resource_name VARCHAR(200) COMMENT '资源名称',
    old_values JSON COMMENT '变更前数据',
    new_values JSON COMMENT '变更后数据',
    result TINYINT DEFAULT 1 COMMENT '操作结果：1-成功，0-失败',
    error_message TEXT COMMENT '错误信息',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_id VARCHAR(64) COMMENT '请求ID',
    duration_ms INT COMMENT '操作耗时(毫秒)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_tenant_user (tenant_id, user_id),
    INDEX idx_action (action),
    INDEX idx_resource_type (resource_type),
    INDEX idx_created_at (created_at),
    INDEX idx_session_id (session_id),
    INDEX idx_result (result),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 7.5 配置管理表（新增）

**系统配置表（system_configs）**
```sql
CREATE TABLE system_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
    config_value TEXT COMMENT '配置值',
    config_type VARCHAR(20) DEFAULT 'string' COMMENT '配置类型：string,number,boolean,json',
    category VARCHAR(50) DEFAULT 'general' COMMENT '配置分类',
    description TEXT COMMENT '配置描述',
    is_encrypted TINYINT DEFAULT 0 COMMENT '是否加密存储',
    is_public TINYINT DEFAULT 0 COMMENT '是否公开配置',
    validation_rule VARCHAR(500) COMMENT '验证规则',
    default_value TEXT COMMENT '默认值',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    INDEX idx_category (category),
    INDEX idx_config_type (config_type),
    INDEX idx_is_public (is_public)
);
```

**租户配置表（tenant_configs）**
```sql
CREATE TABLE tenant_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '租户ID',
    config_key VARCHAR(100) NOT NULL COMMENT '配置键',
    config_value TEXT COMMENT '配置值',
    config_type VARCHAR(20) DEFAULT 'string' COMMENT '配置类型：string,number,boolean,json',
    category VARCHAR(50) DEFAULT 'general' COMMENT '配置分类',
    inherit_system TINYINT DEFAULT 1 COMMENT '是否继承系统配置',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by BIGINT COMMENT '更新人',
    UNIQUE KEY uk_tenant_key (tenant_id, config_key),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_category (category),
    INDEX idx_inherit_system (inherit_system),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

### 7.6 多租户数据隔离技术实现

**行级安全策略（PostgreSQL RLS）**
```sql
-- 启用行级安全
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE role_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenant_configs ENABLE ROW LEVEL SECURITY;

-- 创建租户隔离策略
CREATE POLICY tenant_isolation_policy ON users
    FOR ALL TO application_role
    USING (tenant_id = current_setting('app.current_tenant_id')::BIGINT);

CREATE POLICY tenant_isolation_policy ON roles
    FOR ALL TO application_role
    USING (tenant_id = current_setting('app.current_tenant_id')::BIGINT);

-- 系统管理员策略（可访问所有租户数据）
CREATE POLICY system_admin_policy ON users
    FOR ALL TO system_admin_role
    USING (true);
```

**数据分片策略（大规模场景）**
```sql
-- 按租户ID进行分区
CREATE TABLE users_partitioned (
    LIKE users INCLUDING ALL
) PARTITION BY HASH (tenant_id);

-- 创建分区表
CREATE TABLE users_partition_0 PARTITION OF users_partitioned
    FOR VALUES WITH (MODULUS 4, REMAINDER 0);
CREATE TABLE users_partition_1 PARTITION OF users_partitioned
    FOR VALUES WITH (MODULUS 4, REMAINDER 1);
CREATE TABLE users_partition_2 PARTITION OF users_partitioned
    FOR VALUES WITH (MODULUS 4, REMAINDER 2);
CREATE TABLE users_partition_3 PARTITION OF users_partitioned
    FOR VALUES WITH (MODULUS 4, REMAINDER 3);
```

## 8. 核心 API 示例

**v4.5.1重大更新：** 新增完整的用户、角色、权限管理API，会话管理API，审计日志API和配置管理API。

### 8.1 认证与会话管理API

**用户登录API**
```http
POST /api/v1/auth/login
Content-Type: application/json

{
    "tenant_code": "demo_company",
    "username": "admin",
    "password": "password123",
    "auth_type": "password",
    "remember_me": true,
    "device_info": {
        "device_type": "web",
        "browser": "Chrome 120.0",
        "os": "Windows 11"
    }
}

Response:
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "expires_in": 7200,
        "session_id": "sess_1234567890abcdef",
        "user_info": {
            "id": 1001,
            "username": "admin",
            "real_name": "系统管理员",
            "email": "admin@demo.com",
            "tenant_id": 1,
            "roles": ["admin", "user"],
            "permissions": ["user:read", "user:write", "system:config"]
        }
    }
}
```

**会话管理API**
```http
GET /api/v1/auth/sessions
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "current_session": "sess_1234567890abcdef",
        "sessions": [
            {
                "session_id": "sess_1234567890abcdef",
                "device_type": "web",
                "ip_address": "192.168.1.100",
                "location": "北京市",
                "created_at": "2024-08-14 10:00:00",
                "last_accessed_at": "2024-08-14 14:30:00",
                "status": "active"
            }
        ]
    }
}

DELETE /api/v1/auth/sessions/{session_id}
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "会话已注销"
}
```

**权限验证API**
```http
POST /api/v1/auth/check-permission
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "resource_type": "api",
    "resource_path": "/api/v1/users",
    "action": "read"
}

Response:
{
    "code": 200,
    "message": "权限验证成功",
    "data": {
        "granted": true,
        "permission_code": "user:read",
        "granted_by_roles": ["admin", "user_manager"]
    }
}
```

### 8.2 用户管理API（新增完整CRUD）

**创建用户API**
```http
POST /api/v1/users
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "username": "john_doe",
    "email": "john@demo.com",
    "phone": "13800138000",
    "real_name": "约翰·多伊",
    "password": "TempPassword123!",
    "role_ids": [2, 3],
    "status": 1
}

Response:
{
    "code": 200,
    "message": "用户创建成功",
    "data": {
        "id": 1002,
        "username": "john_doe",
        "email": "john@demo.com",
        "real_name": "约翰·多伊",
        "status": 1,
        "created_at": "2024-08-14 15:00:00"
    }
}
```

**批量用户导入API**
```http
POST /api/v1/users/batch-import
Authorization: Bearer {access_token}
Content-Type: multipart/form-data

file: users.xlsx
options: {
    "default_role_ids": [3],
    "send_welcome_email": true,
    "force_password_reset": true
}

Response:
{
    "code": 200,
    "message": "批量导入完成",
    "data": {
        "total": 100,
        "success": 95,
        "failed": 5,
        "failed_records": [
            {
                "row": 10,
                "username": "duplicate_user",
                "error": "用户名已存在"
            }
        ]
    }
}
```

### 8.3 角色权限管理API（新增）

**角色管理API**
```http
POST /api/v1/roles
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "role_code": "project_manager",
    "role_name": "项目经理",
    "description": "负责项目管理和团队协调",
    "parent_role_id": null,
    "permission_ids": [1, 2, 5, 8]
}

Response:
{
    "code": 200,
    "message": "角色创建成功",
    "data": {
        "id": 10,
        "role_code": "project_manager",
        "role_name": "项目经理",
        "description": "负责项目管理和团队协调",
        "status": 1,
        "created_at": "2024-08-14 15:30:00"
    }
}

GET /api/v1/roles/{id}/permissions
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "role_info": {
            "id": 10,
            "role_name": "项目经理"
        },
        "permissions": [
            {
                "id": 1,
                "permission_code": "project:read",
                "permission_name": "查看项目",
                "resource_type": "api",
                "action": "read"
            }
        ],
        "inherited_permissions": [
            {
                "id": 2,
                "permission_code": "user:read",
                "permission_name": "查看用户",
                "inherited_from": "基础用户角色"
            }
        ]
    }
}
```

**权限分配API**
```http
POST /api/v1/roles/{role_id}/permissions
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "permission_ids": [10, 11, 12],
    "action": "grant"
}

Response:
{
    "code": 200,
    "message": "权限分配成功",
    "data": {
        "granted_permissions": 3,
        "total_permissions": 15
    }
}
```

### 8.4 配置管理API（新增）

**系统配置API**
```http
GET /api/v1/admin/configs?category=security&page=1&size=20
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "total": 25,
        "items": [
            {
                "config_key": "security.password_policy.min_length",
                "config_value": "8",
                "config_type": "number",
                "category": "security",
                "description": "密码最小长度",
                "is_public": false
            }
        ]
    }
}

PUT /api/v1/admin/configs/{config_key}
Authorization: Bearer {access_token}
Content-Type: application/json

{
    "config_value": "12",
    "description": "更新密码最小长度要求"
}

Response:
{
    "code": 200,
    "message": "配置更新成功"
}
```

**租户配置API**
```http
GET /api/v1/tenant/configs
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "configs": [
            {
                "config_key": "ui.theme",
                "config_value": "dark",
                "config_type": "string",
                "inherit_system": false
            },
            {
                "config_key": "security.session_timeout",
                "config_value": "7200",
                "config_type": "number",
                "inherit_system": true,
                "system_value": "3600"
            }
        ]
    }
}
```

### 8.5 审计日志API（新增）

**查询审计日志API**
```http
GET /api/v1/audit/logs?start_time=2024-08-14T00:00:00&end_time=2024-08-14T23:59:59&action=user:create&page=1&size=20
Authorization: Bearer {access_token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "total": 156,
        "page": 1,
        "size": 20,
        "items": [
            {
                "id": 12345,
                "user_id": 1001,
                "username": "admin",
                "action": "user:create",
                "resource_type": "user",
                "resource_id": "1002",
                "resource_name": "john_doe",
                "result": 1,
                "ip_address": "192.168.1.100",
                "duration_ms": 150,
                "created_at": "2024-08-14 15:00:00"
            }
        ]
    }
}
```

### 8.6 跨模块集成接口（新增）

**模块间权限验证接口**
```http
POST /api/v1/internal/auth/verify
Content-Type: application/json
X-Internal-Service: ticket-service

{
    "user_id": 1001,
    "tenant_id": 1,
    "resource_type": "api",
    "resource_path": "/api/v1/tickets",
    "action": "create"
}

Response:
{
    "code": 200,
    "message": "验证成功",
    "data": {
        "granted": true,
        "user_info": {
            "id": 1001,
            "username": "admin",
            "tenant_id": 1
        }
    }
}
```

**租户信息查询接口**
```http
GET /api/v1/internal/tenants/{tenant_id}
X-Internal-Service: crm-service

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "id": 1,
        "tenant_code": "demo_company",
        "tenant_name": "演示公司",
        "status": 1,
        "max_users": 500,
        "config": {
            "timezone": "Asia/Shanghai",
            "language": "zh-CN"
        }
    }
}
```

## 9. 异常与边界场景

**v4.5.1增强：** 新增会话管理、权限验证、审计日志等场景的异常处理。

### 9.1 认证与会话异常场景

**认证异常场景**
- **密码错误**：连续5次密码错误锁定账户15分钟，记录安全审计日志，发送告警通知
- **账户过期**：账户过期后禁止登录，返回特定错误码，提示联系管理员续费
- **并发登录**：检测异地登录，发送安全提醒，支持强制下线其他会话
- **令牌过期**：访问令牌过期时自动使用刷新令牌获取新令牌，刷新令牌过期则要求重新登录

**会话管理异常场景（新增）**
- **会话劫持检测**：检测到IP地址或设备信息异常变化时，立即终止会话并记录安全事件
- **会话超时**：会话超时自动清理，支持优雅下线和数据保存提醒
- **并发会话限制**：超过单用户最大会话数时，自动清理最旧的会话
- **会话存储故障**：Redis故障时降级到数据库存储，确保会话功能可用

### 9.2 权限控制异常场景（新增）

**权限验证异常**
- **权限不足**：返回403错误，记录未授权访问尝试，支持权限申请流程
- **角色冲突**：用户拥有冲突权限时，采用最小权限原则，记录冲突日志
- **权限过期**：临时权限过期自动回收，通知用户和管理员
- **权限继承异常**：角色继承链断裂时，回退到直接分配的权限

**RBAC模型异常**
- **循环继承**：检测角色继承的循环依赖，阻止创建并提示错误
- **权限资源不存在**：验证权限时发现资源已删除，自动清理相关权限分配
- **批量权限操作失败**：部分权限分配失败时，支持事务回滚和部分成功处理

### 9.3 多租户异常场景

**租户隔离异常**
- **跨租户访问尝试**：立即阻断请求，记录安全事件，触发告警机制
- **租户数据泄露**：检测到数据查询返回其他租户数据时，立即中断并审计
- **租户配置冲突**：租户配置与系统配置冲突时，优先使用租户配置并记录

**租户资源限制**
- **用户数超限**：超过租户用户数限制时，禁止新增用户并提示升级套餐
- **存储超限**：存储空间超限时，禁止上传文件并提供清理建议
- **API限流**：超过租户API调用限制时，返回429状态码并记录限流日志

### 9.4 系统级异常场景

**数据库异常**
- **主库故障**：自动切换到只读副本，降级服务功能，保证查询可用
- **连接池耗尽**：动态扩展连接池，记录性能告警，触发自动扩容
- **事务死锁**：自动重试机制，超过重试次数后返回错误并记录

**缓存异常**
- **Redis故障**：降级到数据库查询，启用本地缓存，保证功能可用性
- **缓存穿透**：布隆过滤器防护，空值缓存策略，限制查询频率
- **缓存雪崩**：缓存过期时间随机化，预热机制，熔断保护

## 10. 性能 / 容量规划

**v4.5.1增强：** 新增权限验证、会话管理、审计日志的性能规划。

### 10.1 计算资源规划

**基础配置**
- **CPU需求**：基础配置16核，支持1000并发用户，权限验证服务独立部署4核
- **内存需求**：基础配置32GB，权限缓存8GB，会话缓存4GB，应用内存16GB，系统预留4GB
- **存储需求**：数据库存储1TB起步，审计日志500GB/年，配置数据100GB
- **网络带宽**：基础带宽100Mbps，峰值带宽1Gbps，CDN加速静态资源

**扩展配置**
- **水平扩展**：支持API服务多实例部署，权限验证服务独立扩展
- **垂直扩展**：支持单实例最大64核128GB配置
- **存储扩展**：支持分库分表，单表最大1000万记录

### 10.2 数据库容量规划

**核心业务数据**
- **用户数据**：单租户最大10万用户，平均每用户数据2KB，总计200MB
- **权限数据**：权限表1万条记录，角色表1000条，用户角色关联表100万条
- **会话数据**：10000并发会话，每会话3KB，总计30MB，保留7天历史
- **审计日志**：日产生10万条记录，每条1KB，年累计36GB

**索引和缓存规划**
- **数据库索引**：核心查询索引占用存储空间的20%
- **Redis缓存**：用户权限缓存100MB，会话缓存30MB，配置缓存10MB
- **查询缓存**：热点查询结果缓存，预留200MB空间

### 10.3 性能基准指标

**API性能指标**
- **认证API**：登录响应时间≤1秒，权限验证≤50ms
- **用户管理API**：CRUD操作响应时间≤200ms
- **批量操作API**：1000条记录批量处理≤10秒
- **审计查询API**：复杂查询响应时间≤2秒

**并发性能指标**
- **认证并发**：支持1000 QPS登录请求
- **权限验证并发**：支持10000 QPS权限验证
- **会话管理并发**：支持5000 QPS会话操作
- **审计日志写入**：支持2000 QPS日志写入

## 11. 安全与合规

**v4.5.1重大增强：** 完善了权限控制、审计合规、会话安全的全面设计。

### 11.1 数据安全

**传输安全**
- **加密协议**：强制使用TLS 1.3加密所有HTTP通信，禁用低版本协议
- **证书管理**：支持自动证书更新，证书过期提前30天告警
- **API安全**：所有API强制HTTPS访问，支持HSTS头部

**存储安全**
- **数据库加密**：使用AES-256加密敏感字段，密钥定期轮换（90天）
- **密码安全**：使用bcrypt哈希存储密码，支持密码强度策略
- **敏感数据脱敏**：日志和审计中自动脱敏个人信息

### 11.2 访问控制安全

**身份认证安全**
- **多因子认证**：支持TOTP、短信、邮件等多种MFA方式
- **密码策略**：强制复杂密码，定期更换，防止密码重用
- **异常登录检测**：基于IP、设备、时间的异常登录检测和告警

**权限控制安全（新增）**
- **最小权限原则**：默认无权限，显式授权，定期权限审查
- **权限时效性**：支持临时权限，自动过期回收
- **权限审计**：完整的权限变更审计链，支持权限回溯

**会话安全（新增）**
- **会话加固**：会话ID使用安全随机数生成，定期轮换
- **会话监控**：实时监控异常会话，支持强制下线
- **会话隔离**：不同设备会话独立管理，支持选择性下线

### 11.3 审计合规

**操作审计**
- **全量审计**：记录所有用户操作，包括登录、数据修改、权限变更
- **系统审计**：记录系统级操作，包括配置变更、数据备份、故障处理
- **审计完整性**：审计日志防篡改，支持数字签名验证

**合规认证**
- **等保三级**：满足等保三级安全要求，定期安全评估
- **ISO27001**：符合信息安全管理体系标准
- **数据保护**：符合GDPR、PIPL等数据保护法规要求

**审计查询与报告**
- **实时查询**：支持多维度审计日志查询和统计
- **合规报告**：自动生成合规审计报告，支持定期导出
- **异常告警**：基于审计日志的异常行为检测和告警

## 12. 测试与验收标准

**v4.5.1增强：** 新增权限模型、会话管理、审计日志的专项测试要求。

### 12.1 功能测试

**认证功能测试**
- **多种认证方式**：用户名密码、手机验证码、企业SSO、MFA认证
- **会话管理测试**：会话创建、续期、超时、强制下线、并发会话控制
- **异常场景测试**：密码错误锁定、账户过期、异地登录检测

**权限控制测试（新增）**
- **RBAC模型测试**：角色创建、权限分配、用户角色关联、权限继承
- **API权限测试**：每个API接口的权限验证，权限不足的拒绝访问
- **数据权限测试**：多租户数据隔离，跨租户访问阻断
- **权限边界测试**：权限过期、角色禁用、权限冲突处理

**多租户功能测试**
- **数据隔离测试**：租户间数据完全隔离，无数据泄露
- **资源隔离测试**：租户配置独立，资源使用限制
- **租户管理测试**：租户创建、停用、过期处理

**审计日志测试（新增）**
- **日志记录测试**：所有操作的日志记录完整性和准确性
- **日志查询测试**：多维度查询、分页、排序、导出功能
- **日志安全测试**：日志防篡改、访问权限控制

### 12.2 性能测试

**负载测试**
- **认证性能**：1000 QPS登录请求，响应时间≤1秒
- **权限验证性能**：10000 QPS权限验证，响应时间≤50ms
- **会话管理性能**：5000 QPS会话操作，10000并发会话管理
- **API性能**：核心API在10000并发用户下，P95响应时间≤200ms

**压力测试**
- **极限并发**：逐步增加并发用户至15000，验证系统稳定性
- **数据库压力**：大量数据写入和查询，验证数据库性能瓶颈
- **缓存压力**：Redis故障场景下的性能表现

**稳定性测试**
- **长时间运行**：连续运行72小时，监控内存泄露和性能衰减
- **故障恢复**：数据库、缓存、消息队列故障的恢复能力
- **数据一致性**：高并发场景下的数据一致性验证

### 12.3 安全测试

**渗透测试**
- **认证安全**：暴力破解、会话劫持、令牌伪造攻击测试
- **权限绕过**：尝试绕过权限控制访问未授权资源
- **注入攻击**：SQL注入、XSS、CSRF等常见攻击防护测试
- **数据泄露**：多租户数据隔离的安全性验证

**漏洞扫描**
- **自动化扫描**：使用OWASP ZAP、Nessus等工具进行漏洞扫描
- **代码审计**：静态代码分析，发现潜在安全漏洞
- **依赖检查**：第三方依赖的安全漏洞检查和修复

### 12.4 验收标准

**功能完整性验收**
- **核心功能**：所有P0功能需求100%实现并通过测试
- **API完整性**：所有定义的API接口实现并通过功能测试
- **权限模型**：RBAC权限模型完整实现，支持细粒度权限控制
- **多租户**：租户数据完全隔离，支持1000+租户

**性能指标验收**
- **响应时间**：API响应时间P95≤200ms，P99≤500ms
- **并发能力**：支持10000+并发用户，权限验证≤50ms
- **吞吐量**：认证1000 QPS，权限验证10000 QPS
- **可用性**：系统可用性≥99.9%

**安全要求验收**
- **渗透测试**：通过第三方安全公司的渗透测试，无高危漏洞
- **合规认证**：满足等保三级要求，通过合规审计
- **数据安全**：数据传输和存储加密，审计日志完整
- **权限安全**：权限控制精确到API级别，无权限绕过漏洞

## 13. 模块依赖

**v4.5.1更新：** 明确了与REQ-008模块的功能边界，新增了跨模块集成接口定义。

### 13.1 对外依赖

**基础设施依赖**
- **PostgreSQL 16.6**：主数据库，支持行级安全策略和分区表，JSON性能提升30%
- **Redis 7.4.1**：会话缓存、权限缓存、配置缓存，内存优化
- **RabbitMQ 3.13.7**：异步消息处理，权限变更通知，性能优化
- **MinIO RELEASE.2024-12-13T22-19-12Z**：文件和对象存储，审计日志归档，S3兼容性增强
- **Elasticsearch 8.15.3**：审计日志搜索和分析

**外部服务依赖**
- **企业SSO系统**：OAuth2.0、OIDC、SAML协议集成
- **短信服务**：MFA验证码发送
- **邮件服务**：安全告警和通知发送
- **监控系统**：Prometheus + Grafana系统监控

### 13.2 被依赖模块

**所有业务模块依赖基础架构提供：**
- **认证服务**：统一的用户认证和令牌验证
- **权限验证**：基于RBAC的API级别权限控制
- **多租户支持**：租户数据隔离和租户信息查询
- **配置服务**：系统配置和租户配置管理
- **审计服务**：操作日志记录和查询

**具体依赖模块：**
- **工作台模块（REQ-002）**：依赖用户认证、权限控制、租户信息
- **工单管理（REQ-003）**：依赖多租户架构、权限验证、审计日志
- **智能派单（REQ-004）**：依赖用户信息、权限验证、配置管理
- **系统管理（REQ-008）**：依赖权限控制、配置管理、审计日志

### 13.3 与REQ-008模块功能边界（新增明确定义）

**基础架构模块（REQ-001）职责：**
- 提供配置数据的存储和基础CRUD API
- 提供租户配置的底层数据模型和访问接口
- 提供配置变更的审计日志记录
- 提供配置缓存和性能优化

**系统设置模块（REQ-008）职责：**
- 提供配置管理的用户界面和交互逻辑
- 提供配置项的业务验证和规则检查
- 提供配置模板和批量配置功能
- 提供配置变更的业务流程管理

**接口契约定义：**
```http
# 基础架构提供的配置API
GET /api/v1/internal/configs/{key}           # 获取配置值
PUT /api/v1/internal/configs/{key}           # 更新配置值
GET /api/v1/internal/tenant-configs/{key}    # 获取租户配置
PUT /api/v1/internal/tenant-configs/{key}    # 更新租户配置

# 系统设置调用的配置管理API
POST /api/v1/admin/configs/validate          # 配置验证
POST /api/v1/admin/configs/batch-update      # 批量更新
GET /api/v1/admin/configs/templates          # 配置模板
```

### 13.4 跨模块集成接口（新增）

**认证集成接口**
```http
POST /api/v1/internal/auth/verify            # 权限验证
GET /api/v1/internal/users/{id}              # 用户信息查询
GET /api/v1/internal/tenants/{id}            # 租户信息查询
```

**审计集成接口**
```http
POST /api/v1/internal/audit/log              # 记录审计日志
GET /api/v1/internal/audit/user-actions      # 查询用户操作记录
```

**配置集成接口**
```http
GET /api/v1/internal/configs/effective       # 获取有效配置（含继承）
POST /api/v1/internal/configs/notify-change  # 配置变更通知
```

**消息通知接口**
```http
POST /api/v1/internal/events/permission-changed    # 权限变更事件
POST /api/v1/internal/events/user-status-changed   # 用户状态变更事件
POST /api/v1/internal/events/tenant-config-changed # 租户配置变更事件
```

---

**文档版本：** 4.5.1
**最后更新：** 2025-08-14
**下一版本计划：** 基于实施反馈进行功能优化和性能调优
