# 双向优化工作流程指南

## 概述

双向优化工作流程是在传统API设计流程基础上的重要改进，通过AI同时进行API设计和PRD质量分析，形成PRD文档与API设计的双向优化循环。

## 工作流程架构

### 传统单向流程
```
PRD 4.5 → AI分析 → API设计 → 实施
```

### 双向优化流程
```
PRD 4.5 → AI分析 → {API设计 + PRD改进建议} → 人工审核 → PRD 4.5.1 → 重新生成API
```

## 核心特性

### 1. 分离式设计
- **主要任务**：API设计（保持原有质量）
- **辅助任务**：PRD质量分析（可选启用）
- **避免冲突**：两个任务使用不同的prompt模板

### 2. 可选功能
- **默认关闭**：不影响现有工作流程
- **按需启用**：通过环境变量控制
- **灵活配置**：可以针对特定模块启用

### 3. 版本化管理
- **输出隔离**：PRD改进建议独立存储
- **版本追踪**：支持PRD子版本管理
- **历史保留**：保留所有版本的分析结果

## 使用方法

### 1. 基本用法（仅API设计）

```bash
# 传统模式，仅生成API设计prompt
bash scripts/gen_iter_prompt.sh api P0
```

### 2. 双向分析模式

```bash
# 启用PRD分析功能
ENABLE_PRD_ANALYSIS=true bash scripts/gen_iter_prompt.sh api P0
```

### 3. 批量处理

```bash
# 对所有阶段启用双向分析
ENABLE_PRD_ANALYSIS=true bash scripts/gen_iter_prompt.sh api all
```

## 输出结构

### 1. API设计输出（原有）
```
prompts/4.5/api/
├── api-iter-REQ-001.md
├── api-iter-REQ-003.md
└── ...
```

### 2. PRD分析输出（新增）
```
prompts/4.5/prd-analysis/
├── prd-analysis-REQ-001.md
├── prd-analysis-REQ-003.md
└── ...

docs/output/4.5/prd-improvements/
├── REQ-001-prd-analysis.md
├── REQ-003-prd-analysis.md
└── ...
```

## PRD分析内容

### 1. 分析维度
- **技术细节完整性**：数据模型、接口流程、性能要求
- **业务逻辑一致性**：跨模块交互、状态流转、异常处理
- **API设计支撑度**：CRUD覆盖、查询需求、批量操作
- **数据架构合理性**：实体关系、完整性约束、索引优化

### 2. 改进建议分类
- **P0-关键缺失**：影响核心功能实现的关键信息
- **P1-重要补充**：提升实现质量的重要细节
- **P2-优化建议**：改善用户体验和系统性能

### 3. 输出格式
```markdown
# REQ-XXX PRD质量分析报告

## 分析概要
- 分析时间、PRD版本、分析模块

## 关键发现
### P0级问题（关键缺失）
### P1级问题（重要补充）  
### P2级问题（优化建议）

## 详细分析
### 技术细节完整性
### 业务逻辑一致性
### API设计支撑度
### 数据架构合理性

## 改进建议
### 立即处理（P0）
### 近期优化（P1）
### 长期改进（P2）

## 技术实现指导
```

## 版本管理策略

### 1. PRD版本演进
```
PRD 4.5 → 分析 → 改进建议 → PRD 4.5.1 → 重新分析 → PRD 4.5.2
```

### 2. 目录结构
```
docs/prd/split/
├── 4.5/           # 原始版本
├── 4.5.1/         # 第一次改进版本
└── 4.5.2/         # 第二次改进版本

docs/output/
├── 4.5/prd-improvements/     # 原始版本的分析
├── 4.5.1/prd-improvements/   # 改进版本的分析
└── 4.5.2/prd-improvements/   # 再次改进的分析
```

### 3. 版本检测
- 脚本自动检测最新PRD版本
- 支持手动指定特定版本
- 保持向后兼容性

## 质量控制机制

### 1. 分析质量保证
- **客观性**：基于技术标准和最佳实践
- **具体性**：提供可操作的具体建议
- **优先级**：明确区分问题严重程度
- **可行性**：确保建议在当前技术栈下可实现

### 2. 人工审核流程
1. **自动分析**：AI生成PRD改进建议
2. **技术审核**：技术负责人评估建议价值
3. **业务审核**：产品负责人评估业务影响
4. **优先级排序**：确定改进实施顺序
5. **PRD更新**：根据审核结果更新PRD

### 3. 迭代优化
- **反馈收集**：收集改进建议的实施效果
- **模板优化**：根据反馈优化分析模板
- **流程改进**：持续改进双向分析流程

## 最佳实践

### 1. 启用策略
```bash
# 核心模块启用双向分析
ENABLE_PRD_ANALYSIS=true bash scripts/gen_iter_prompt.sh api P0

# 一般模块仅生成API设计
bash scripts/gen_iter_prompt.sh api P1
```

### 2. 审核流程
1. **快速扫描**：先查看P0级问题
2. **详细评估**：评估P1级问题的价值
3. **长期规划**：将P2级问题纳入长期规划
4. **分批实施**：避免一次性修改过多

### 3. 版本管理
- **小步迭代**：每次只处理少量高优先级问题
- **版本标记**：清晰标记每个版本的改进内容
- **回滚准备**：保留原始版本以备回滚

## 风险控制

### 1. AI工作效果保护
- **分离设计**：确保API设计质量不受影响
- **可选功能**：默认关闭，按需启用
- **独立模板**：使用专门的PRD分析模板

### 2. 版本管理风险
- **自动备份**：修改PRD前自动备份
- **版本标记**：清晰的版本号管理
- **依赖追踪**：跟踪PRD变更对API的影响

### 3. 工作流程风险
- **渐进实施**：先在小范围测试
- **效果评估**：定期评估双向分析的价值
- **流程调整**：根据实际效果调整流程

## 成功指标

### 1. 质量指标
- **PRD完整性提升**：缺失信息的减少比例
- **API设计质量**：接口设计的一致性和完整性
- **实施效率**：开发过程中的问题减少

### 2. 效率指标
- **问题发现率**：提前发现的问题比例
- **修改成本**：PRD修改的时间成本
- **开发速度**：整体开发效率的提升

### 3. 团队指标
- **满意度**：开发团队对PRD质量的满意度
- **协作效率**：产品与技术团队的协作效率
- **知识积累**：团队对业务理解的深度

## 总结

双向优化工作流程通过AI的双重分析能力，实现了PRD文档与API设计的相互促进，形成了一个持续改进的闭环。这种方法不仅提升了API设计的质量，更重要的是提升了PRD文档的技术可实施性，为整个项目的成功奠定了坚实的基础。
